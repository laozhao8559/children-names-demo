<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ä¿®å¤æ ·å¼å†²çª */
        @media print {
            .step-content {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ¨ å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</h1>
            <p>æ ¹æ®ä¸»é¢˜/åœºæ™¯è‡ªåŠ¨ç”Ÿæˆå„¿ç«¥è¯†å­—å°æŠ¥ç»˜å›¾Prompt</p>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="showHistory()">ğŸ“š å†å²è®°å½•</button>
                <button class="btn btn-info" onclick="clearAllHistory()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
            </div>
        </header>

        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="steps-indicator">
            <div class="step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-title">æ”¶é›†ä¿¡æ¯</span>
            </div>
            <div class="step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-title">ç”Ÿæˆè¯æ±‡</span>
            </div>
            <div class="step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-title">åˆ›å»ºæ ‡ç­¾</span>
            </div>
            <div class="step" data-step="4">
                <span class="step-number">4</span>
                <span class="step-title">ç”ŸæˆPrompt</span>
            </div>
            <div class="step" data-step="5">
                <span class="step-number">5</span>
                <span class="step-title">å®Œæˆ</span>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <main class="main-content">
            <!-- æ­¥éª¤1: 5ä¸ªé—®é¢˜ -->
            <div id="step1" class="step-content active">
                <h2>ğŸ“‹ è¯·å›ç­”ä»¥ä¸‹5ä¸ªé—®é¢˜</h2>
                <form id="questionsForm">
                    <div class="form-group">
                        <label for="theme">1. æœ¬æœŸå„¿ç«¥è¯†å­—å°æŠ¥çš„ä¸»é¢˜/åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                        <div style="margin-bottom: 10px;">
                            <select id="theme" name="theme" required onchange="handleThemeChange()">
                                <option value="">è¯·é€‰æ‹©ä¸»é¢˜...</option>
                                <optgroup label="æ—¥å¸¸ç”Ÿæ´»åœºæ™¯">
                                    <option value="è¶…å¸‚">è¶…å¸‚</option>
                                    <option value="å®¶é‡Œ">å®¶é‡Œ</option>
                                    <option value="å­¦æ ¡">å­¦æ ¡</option>
                                    <option value="åŒ»é™¢">åŒ»é™¢</option>
                                </optgroup>
                                <optgroup label="æˆ·å¤–æ´»åŠ¨åœºæ™¯">
                                    <option value="å…¬å›­">å…¬å›­</option>
                                    <option value="æ¸¸ä¹åœº">æ¸¸ä¹åœº</option>
                                    <option value="åŠ¨ç‰©å›­">åŠ¨ç‰©å›­</option>
                                </optgroup>
                                <optgroup label="äº¤é€šåœºæ™¯">
                                    <option value="å…¬äº¤ç«™">å…¬äº¤ç«™</option>
                                    <option value="ç«è½¦ç«™">ç«è½¦ç«™</option>
                                    <option value="é£æœºåœº">é£æœºåœº</option>
                                </optgroup>
                                <optgroup label="æ–‡åŒ–æ•™è‚²åœºæ™¯">
                                    <option value="å›¾ä¹¦é¦†">å›¾ä¹¦é¦†</option>
                                    <option value="åšç‰©é¦†">åšç‰©é¦†</option>
                                    <option value="ä¹¦åº—">ä¹¦åº—</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–åœºæ™¯">
                                    <option value="custom">è‡ªå®šä¹‰è¾“å…¥</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- è‡ªå®šä¹‰è¾“å…¥æ¡† -->
                        <div id="customThemeDiv" style="display: none;">
                            <input type="text" id="customTheme" name="customTheme"
                                   placeholder="è¯·è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰åœºæ™¯..."
                                   style="width: 100%; padding: 12px 15px; border: 2px solid #4CAF50; border-radius: 8px; font-size: 16px;">
                            <small>ä¾‹å¦‚ï¼šèœå¸‚åœºã€é¢åŒ…åº—ã€èŠ±åº—ã€é‚®å±€ã€é“¶è¡Œç­‰</small>
                        </div>

                        <small>æ”¯æŒ13ä¸ªåœºæ™¯ï¼Œæˆ–è‡ªå®šä¹‰è¾“å…¥ä»»ä½•æ‚¨æƒ³è¦çš„åœºæ™¯</small>
                    </div>

                    <div class="form-group">
                        <label for="title">2. å°æŠ¥çš„å¤§æ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                        <input type="text" id="title" name="title" placeholder="å¦‚ï¼šã€Šèµ°è¿›è¶…å¸‚ã€‹ã€Šå¿«ä¹åŒ»é™¢ã€‹ã€Šæ£®æ—å¤§å†’é™©ã€‹" required>
                    </div>

                    <div class="form-group">
                        <label>3. ä½ å¸Œæœ›æ ‡ç­¾æ˜¾ç¤ºå“ªäº›è¯­è¨€ï¼Ÿï¼ˆå¯ä»»æ„ç»„åˆï¼‰</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="languages" value="chinese" checked>
                                <span>ä¸­æ–‡</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="languages" value="pinyin">
                                <span>æ‹¼éŸ³</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="languages" value="english">
                                <span>è‹±æ–‡</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="languages" value="japanese">
                                <span>æ—¥æ–‡</span>
                            </label>
                        </div>
                        <small>æ”¯æŒä»»æ„ç»„åˆï¼šä¸­æ–‡ã€ä¸­æ–‡+æ‹¼éŸ³ã€ä¸­æ–‡+è‹±æ–‡ã€å…¨é€‰ç­‰</small>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">4. ä½ å¸Œæœ›æœ¬æœŸè¯æ±‡éš¾åº¦ç­‰çº§æ˜¯ï¼Ÿ</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="difficulty" value="level1" checked>
                                <div class="radio-content">
                                    <strong>Level 1ï¼š</strong>æ—¥å¸¸å¸¸è§ï¼ˆé€‚åˆ 5â€“6 å²ï¼‰
                                </div>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="difficulty" value="level2">
                                <div class="radio-content">
                                    <strong>Level 2ï¼š</strong>åœºæ™¯å®Œæ•´è¯æ±‡ï¼ˆé€‚åˆ 6â€“8 å²ï¼‰
                                </div>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="difficulty" value="level3">
                                <div class="radio-content">
                                    <strong>Level 3ï¼š</strong>ç»†èŠ‚ä¸°å¯Œã€éš¾åº¦è¾ƒé«˜ï¼ˆé€‚åˆ 8â€“9 å²ï¼‰
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="environment">5. ç”»é¢éœ€è¦ä½“ç°å­£èŠ‚ã€å¤©æ°”æˆ–åœ°ç†ç‰¹å¾å—ï¼Ÿ</label>
                        <select id="environment" name="environment">
                            <option value="">æ— ç‰¹åˆ«è¦æ±‚</option>
                            <optgroup label="å­£èŠ‚">
                                <option value="æ˜¥å­£">æ˜¥å­£</option>
                                <option value="å¤å­£">å¤å­£</option>
                                <option value="ç§‹å­£">ç§‹å­£</option>
                                <option value="å†¬å­£">å†¬å­£</option>
                            </optgroup>
                            <optgroup label="å¤©æ°”">
                                <option value="æ™´å¤©">æ™´å¤©</option>
                                <option value="é›¨å¤©">é›¨å¤©</option>
                                <option value="é˜´å¤©">é˜´å¤©</option>
                                <option value="é›ªå¤©">é›ªå¤©</option>
                                <option value="é›¾å¤©">é›¾å¤©</option>
                            </optgroup>
                            <optgroup label="åœ°ç†">
                                <option value="æ£®æ—">æ£®æ—</option>
                                <option value="åŸå¸‚">åŸå¸‚</option>
                                <option value="ä¹¡æ‘">ä¹¡æ‘</option>
                                <option value="å±±åœ°">å±±åœ°</option>
                                <option value="æµ·è¾¹">æµ·è¾¹</option>
                            </optgroup>
                        </select>
                        <input type="text" id="customEnvironment" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰æè¿°" style="margin-top: 10px;">
                    </div>

                    <button type="submit" class="btn btn-primary">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè¯æ±‡</button>
                </form>
            </div>

            <!-- æ­¥éª¤2: æ˜¾ç¤ºç”Ÿæˆçš„è¯æ±‡ -->
            <div id="step2" class="step-content">
                <h2>ğŸ“š è‡ªåŠ¨ç”Ÿæˆçš„è¯æ±‡åº“</h2>
                <div id="vocabularyList" class="vocabulary-list">
                    <p>æ­£åœ¨ç”Ÿæˆè¯æ±‡...</p>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆæ ‡ç­¾</button>
                </div>
            </div>

            <!-- æ­¥éª¤3: æ˜¾ç¤ºæ ‡ç­¾ç»„åˆ -->
            <div id="step3" class="step-content">
                <h2>ğŸ·ï¸ æ ‡ç­¾ç»„åˆç»“æœ</h2>
                <div id="tagList" class="tag-list">
                    <p>æ­£åœ¨ç”Ÿæˆæ ‡ç­¾...</p>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥ï¼šç”ŸæˆPrompt</button>
                </div>
            </div>

            <!-- æ­¥éª¤4: ç”ŸæˆPrompt -->
            <div id="step4" class="step-content">
                <h2>ğŸ¯ ç»˜å›¾Promptç”Ÿæˆ</h2>
                <div id="promptResult" class="prompt-result">
                    <p>æ­£åœ¨ç”Ÿæˆç»˜å›¾Prompt...</p>
                </div>
                <div class="api-section">
                    <h3>APIé…ç½®</h3>
                    <div class="form-group">
                        <label for="apiKey">API Key:</label>
                        <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„Nano Banana Pro API Key">
                        <small>è·å–API Key: <a href="https://kie.ai/api-key" target="_blank">https://kie.ai/api-key</a></small>
                    </div>
                    <button class="btn btn-success" onclick="generateImage()">ç”Ÿæˆå›¾åƒ</button>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                </div>
            </div>

            <!-- æ­¥éª¤5: å®Œæˆ -->
            <div id="step5" class="step-content">
                <h2>ğŸ‰ ç”Ÿæˆå®Œæˆï¼</h2>
                <div id="finalResult" class="final-result">
                    <div class="result-section">
                        <h3>ğŸ“¸ ç”Ÿæˆçš„å›¾åƒ</h3>
                        <div id="generatedImage" class="image-container">
                            <p>å›¾åƒç”Ÿæˆä¸­...</p>
                        </div>
                    </div>

                    <div class="result-section">
                        <h3>ğŸ“ è¯æ±‡æ€»è¡¨</h3>
                        <div id="vocabularyTable" class="vocabulary-table"></div>
                    </div>

                    <div class="result-section">
                        <h3>ğŸ’¾ ä¸‹è½½</h3>
                        <div class="download-buttons">
                            <button class="btn btn-primary" onclick="downloadImage()">ä¸‹è½½å›¾åƒ</button>
                            <button class="btn btn-secondary" onclick="copyPrompt()">å¤åˆ¶Prompt</button>
                            <button class="btn btn-info" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="restart()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </main>

        <!-- åŠ è½½æç¤º -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
            <p id="loadingText">å¤„ç†ä¸­...</p>
        </div>

        <!-- å†å²è®°å½•å¼¹çª— -->
        <div id="historyModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“š ç”Ÿæˆå†å²è®°å½•</h2>
                    <button class="close-btn" onclick="closeHistory()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="historyList" class="history-list">
                        <p class="no-history">æš‚æ— å†å²è®°å½•</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeHistory()">å…³é—­</button>
                    <button class="btn btn-primary" onclick="exportHistory()">å¯¼å‡ºå†å²</button>
                </div>
            </div>
        </div>
    </div>

    <script src="vocabulary.js"></script>
    <script>
        // ç»ˆæä¿®å¤ç‰ˆæœ¬ - å®Œå…¨é‡å†™ç¡®ä¿ç¨³å®šæ€§
        let currentStep = 1;
        let userData = {};
        let vocabulary = [];
        let tags = [];
        let finalPrompt = '';

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            setTimeout(initializeApp, 100); // ç¨å¾®å»¶è¿Ÿç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
        });

        function initializeApp() {
            console.log('ğŸ”§ åˆå§‹åŒ–åº”ç”¨');

            try {
                // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
                const form = document.getElementById('questionsForm');
                if (form) {
                    console.log('âœ… æ‰¾åˆ°è¡¨å•ï¼Œç»‘å®šæäº¤äº‹ä»¶');
                    form.addEventListener('submit', handleFormSubmit);
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°è¡¨å•å…ƒç´ ');
                    alert('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                    return;
                }

                // ç»‘å®šç¯å¢ƒé€‰æ‹©å˜åŒ–äº‹ä»¶
                const environmentSelect = document.getElementById('environment');
                const customInput = document.getElementById('customEnvironment');

                if (environmentSelect && customInput) {
                    environmentSelect.addEventListener('change', function() {
                        if (this.value) {
                            customInput.style.display = 'none';
                            customInput.value = '';
                        } else {
                            customInput.style.display = 'block';
                        }
                    });
                }

                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¸»é¢˜å˜åŒ–å¤„ç†
        function handleThemeChange() {
            console.log('ğŸ”„ ä¸»é¢˜å˜åŒ–å¤„ç†');
            const themeSelect = document.getElementById('theme');
            const customDiv = document.getElementById('customThemeDiv');
            const customInput = document.getElementById('customTheme');

            if (themeSelect.value === 'custom') {
                customDiv.style.display = 'block';
                customInput.required = true;
            } else {
                customDiv.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // å¤„ç†è¡¨å•æäº¤
        function handleFormSubmit(e) {
            console.log('ğŸ“‹ è¡¨å•æäº¤å¼€å§‹');
            e.preventDefault();

            // æ”¶é›†ç”¨æˆ·æ•°æ®
            const formData = new FormData(e.target);
            const themeValue = formData.get('theme');
            const customTheme = formData.get('customTheme');

            userData = {
                theme: themeValue === 'custom' ? customTheme : themeValue,
                title: formData.get('title'),
                languages: formData.getAll('languages'),
                difficulty: formData.get('difficulty'),
                environment: formData.get('environment') || document.getElementById('customEnvironment').value
            };

            console.log('ğŸ“Š æ”¶é›†åˆ°çš„æ•°æ®:', userData);

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!userData.theme || userData.theme === '') {
                alert('è¯·é€‰æ‹©ä¸»é¢˜ï¼');
                return;
            }

            if (!userData.title || userData.title === '') {
                alert('è¯·å¡«å†™æ ‡é¢˜ï¼');
                return;
            }

            if (!userData.languages || userData.languages.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§è¯­è¨€ï¼');
                return;
            }

            if (!userData.difficulty || userData.difficulty === '') {
                alert('è¯·é€‰æ‹©éš¾åº¦ç­‰çº§ï¼');
                return;
            }

            console.log('âœ… éªŒè¯é€šè¿‡ï¼Œå¼€å§‹ç”Ÿæˆè¯æ±‡');

            // ç”Ÿæˆè¯æ±‡
            generateVocabulary();
        }

        // ç”Ÿæˆè¯æ±‡
        function generateVocabulary() {
            console.log('ğŸ“š å¼€å§‹ç”Ÿæˆè¯æ±‡');

            try {
                showLoading('æ­£åœ¨ç”Ÿæˆè¯æ±‡åº“...');

                // ç«‹å³è·å–è¯æ±‡
                vocabulary = getVocabulary(userData.theme, userData.difficulty);
                console.log('âœ… æˆåŠŸè·å–è¯æ±‡ï¼Œæ•°é‡:', vocabulary.length);

                // æ˜¾ç¤ºè¯æ±‡
                displayVocabulary();

                // éšè—åŠ è½½æç¤º
                hideLoading();

                // ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory();

                // ç¡®ä¿è·³è½¬åˆ°æ­¥éª¤2
                console.log('ğŸš€ å‡†å¤‡è·³è½¬åˆ°æ­¥éª¤2');
                setTimeout(() => {
                    goToStep(2);
                    console.log('âœ… è·³è½¬å®Œæˆ');
                }, 300);

            } catch (error) {
                console.error('âŒ ç”Ÿæˆè¯æ±‡æ—¶å‡ºé”™:', error);
                hideLoading();
                alert('ç”Ÿæˆè¯æ±‡æ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºè¯æ±‡
        function displayVocabulary() {
            const container = document.getElementById('vocabularyList');
            if (!container) {
                console.error('âŒ æœªæ‰¾åˆ°è¯æ±‡åˆ—è¡¨å®¹å™¨');
                return;
            }

            let html = '<div class="vocabulary-grid">';

            vocabulary.forEach((word, index) => {
                html += `
                    <div class="vocabulary-item">
                        <strong>${index + 1}. ${word.chinese}</strong><br>
                        <small>${word.pinyin}</small><br>
                        <small>${word.english}</small>
                    </div>
                `;
            });

            html += '</div>';

            html += `
                <div class="vocabulary-summary">
                    <h4>è¯æ±‡ä¿¡æ¯</h4>
                    <p><strong>ä¸»é¢˜ï¼š</strong>${userData.theme}</p>
                    <p><strong>éš¾åº¦ï¼š</strong>${getDifficultyDescription()}</p>
                    <p><strong>è¯æ±‡æ•°é‡ï¼š</strong>${vocabulary.length} ä¸ª</p>
                </div>
            `;

            container.innerHTML = html;
        }

        // è·å–éš¾åº¦æè¿°
        function getDifficultyDescription() {
            const difficultyMap = {
                'level1': 'Level 1ï¼šæ—¥å¸¸å¸¸è§ï¼ˆé€‚åˆ 5â€“6 å²ï¼‰',
                'level2': 'Level 2ï¼šåœºæ™¯å®Œæ•´è¯æ±‡ï¼ˆé€‚åˆ 6â€“8 å²ï¼‰',
                'level3': 'Level 3ï¼šç»†èŠ‚ä¸°å¯Œã€éš¾åº¦è¾ƒé«˜ï¼ˆé€‚åˆ 8â€“9 å²ï¼‰'
            };
            return difficultyMap[userData.difficulty] || userData.difficulty;
        }

        // ç”Ÿæˆæ ‡ç­¾
        function generateTags() {
            console.log('ğŸ·ï¸ å¼€å§‹ç”Ÿæˆæ ‡ç­¾');

            try {
                showLoading('æ­£åœ¨ç”Ÿæˆæ ‡ç­¾...');

                tags = generateTagText(vocabulary, userData.languages);
                console.log('âœ… ç”Ÿæˆæ ‡ç­¾æˆåŠŸ:', tags.length);

                displayTags();
                hideLoading();

            } catch (error) {
                console.error('âŒ ç”Ÿæˆæ ‡ç­¾æ—¶å‡ºé”™:', error);
                hideLoading();
                alert('ç”Ÿæˆæ ‡ç­¾æ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºæ ‡ç­¾
        function displayTags() {
            const container = document.getElementById('tagList');
            if (!container) {
                console.error('âŒ æœªæ‰¾åˆ°æ ‡ç­¾åˆ—è¡¨å®¹å™¨');
                return;
            }

            let html = '<div class="tag-grid">';

            tags.forEach((tag, index) => {
                html += `
                    <div class="tag-item">
                        <span class="tag-number">${index + 1}</span>
                        <span class="tag-text">${tag}</span>
                    </div>
                `;
            });

            html += '</div>';

            html += `
                <div class="tag-summary">
                    <h4>æ ‡ç­¾é…ç½®</h4>
                    <ul>
                        <li><strong>ä¸»é¢˜ï¼š</strong>${userData.theme}</li>
                        <li><strong>æ ‡é¢˜ï¼š</strong>${userData.title}</li>
                        <li><strong>è¯­è¨€ç»„åˆï¼š</strong>${getLanguageDescription()}</li>
                        <li><strong>æ ‡ç­¾æ•°é‡ï¼š</strong>${tags.length} ä¸ª</li>
                    </ul>
                </div>
            `;

            container.innerHTML = html;
        }

        // è·å–è¯­è¨€æè¿°
        function getLanguageDescription() {
            const languageMap = {
                'chinese': 'ä¸­æ–‡',
                'pinyin': 'æ‹¼éŸ³',
                'english': 'è‹±æ–‡',
                'japanese': 'æ—¥æ–‡'
            };

            return userData.languages.map(lang => languageMap[lang]).join(' + ');
        }

        // ç”ŸæˆPrompt
        function generatePrompt() {
            console.log('ğŸ¯ å¼€å§‹ç”ŸæˆPrompt');

            try {
                showLoading('æ­£åœ¨ç”Ÿæˆç»˜å›¾Prompt...');

                finalPrompt = createImagePrompt();
                displayPrompt();
                hideLoading();

            } catch (error) {
                console.error('âŒ ç”ŸæˆPromptæ—¶å‡ºé”™:', error);
                hideLoading();
                alert('ç”ŸæˆPromptæ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        // åˆ›å»ºå›¾åƒPrompt
        function createImagePrompt() {
            const sceneDescription = generateSceneDescription();
            const characterDescription = getCharactersByTheme(userData.theme);

            return `å„¿ç«¥è¯†å­—å°æŠ¥æ’å›¾ï¼š${userData.title}

åœºæ™¯æè¿°ï¼š${sceneDescription}

ç”»é¢è¦æ±‚ï¼š
- é£æ ¼ï¼šæ¸©é¦¨å¯çˆ±çš„å„¿ç«¥æ’ç”»é£æ ¼
- è‰²å½©ï¼šæ˜äº®é²œè‰³ï¼Œé€‚åˆå„¿ç«¥è§‚çœ‹
- æ„å›¾ï¼šæ¸…æ™°å±•ç¤ºæ‰€æœ‰è¯æ±‡å¯¹åº”çš„ç‰©å“
- äººç‰©ï¼šåŒ…å«${characterDescription}
- ç¯å¢ƒï¼š${userData.environment ? userData.environment + 'ç¯å¢ƒ' : 'æ˜äº®å¹²å‡€çš„å®¤å†…ç¯å¢ƒ'}

è¯æ±‡æ ‡ç­¾è¦æ±‚ï¼š
æ¯ä¸ªç‰©å“æ—è¾¹éƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹è¯­è¨€çš„æ ‡ç­¾ï¼š${getLanguageDescription()}
æ ‡æ³¨æ ¼å¼è¦æ±‚ï¼š${generateTagFormatExample()}
æ‰€æœ‰è¯æ±‡å¿…é¡»åŒæ—¶åŒ…å«æ‰€æœ‰é€‰æ‹©çš„è¯­è¨€ï¼Œä¸å¾—é—æ¼ï¼

å…·ä½“æ ‡æ³¨ç¤ºä¾‹ï¼š
${generateDetailedTagExamples()}

éœ€è¦åŒ…å«çš„è¯æ±‡ï¼ˆ${vocabulary.length}ä¸ªï¼‰ï¼š
${vocabulary.map((item, index) => `${index + 1}. ${item.chinese}`).join('\n')}

ç”»é¢é£æ ¼ï¼š
- é€‚åˆ5-9å²å„¿ç«¥çš„è®¤çŸ¥æ°´å¹³
- çº¿æ¡ç®€æ´ï¼Œè‰²å½©æ˜å¿«
- æ•™è‚²æ€§å¼ºï¼Œä¾¿äºè¯†å­—å­¦ä¹ 
- æ•´ä½“å¸ƒå±€æ¸…æ™°æœ‰åº`;
        }

        // ç”Ÿæˆåœºæ™¯æè¿°
        function generateSceneDescription() {
            const sceneMap = {
                'è¶…å¸‚': 'ç¹å¿™çš„è¶…å¸‚å†…éƒ¨ï¼Œæœ‰æ•´é½æ’åˆ—çš„è´§æ¶ã€æ˜äº®çš„ç¯å…‰å’Œè´­ç‰©çš„å®¶åº­',
                'å®¶é‡Œ': 'æ¸©é¦¨çš„å®¶åº­å®¢å…ï¼Œæœ‰èˆ’é€‚çš„å®¶å…·å’Œå®¶åº­æˆå‘˜',
                'å­¦æ ¡': 'æ˜äº®çš„æ•™å®¤ï¼Œæœ‰è¯¾æ¡Œæ¤…ã€é»‘æ¿å’Œå­¦ä¹ çš„å­¦ç”Ÿ',
                'åŒ»é™¢': 'å¹²å‡€çš„åŒ»é™¢ç¯å¢ƒï¼Œæœ‰åŒ»ç”Ÿã€æŠ¤å£«å’ŒåŒ»ç–—è®¾å¤‡',
                'å…¬å›­': 'ç»¿è‰²çš„å…¬å›­ç¯å¢ƒï¼Œæœ‰æ ‘æœ¨ã€èŠ±è‰å’Œä¼‘é—²çš„äººä»¬',
                'æ¸¸ä¹åœº': 'æ¬¢ä¹çš„æ¸¸ä¹åœºï¼Œæœ‰å„ç§æ¸¸ä¹è®¾æ–½å’Œå¿«ä¹çš„å­©å­ä»¬',
                'åŠ¨ç‰©å›­': 'ç”ŸåŠ¨çš„åŠ¨ç‰©å›­ï¼Œæœ‰å„ç§åŠ¨ç‰©å’Œå‚è§‚çš„æ¸¸å®¢',
                'å…¬äº¤ç«™': 'åŸå¸‚å…¬äº¤ç«™ï¼Œæœ‰å€™è½¦äº­ã€ç«™ç‰Œå’Œç­‰è½¦çš„ä¹˜å®¢',
                'ç«è½¦ç«™': 'ç¹å¿™çš„ç«è½¦ç«™ï¼Œæœ‰ç«™å°ã€åˆ—è½¦å’Œæ—…å®¢',
                'é£æœºåœº': 'ç°ä»£åŒ–çš„æœºåœºï¼Œæœ‰å€™æœºå…ã€é£æœºå’Œæ—…å®¢',
                'å›¾ä¹¦é¦†': 'å®‰é™çš„å›¾ä¹¦é¦†ï¼Œæœ‰ä¹¦æ¶ã€æ¡Œæ¤…å’Œé˜…è¯»çš„äººä»¬',
                'åšç‰©é¦†': 'åº„é‡çš„åšç‰©é¦†ï¼Œæœ‰å±•å“ã€è¯´æ˜ç‰Œå’Œå‚è§‚è€…',
                'ä¹¦åº—': 'æ¸©é¦¨çš„ä¹¦åº—ï¼Œæœ‰ä¹¦æ¶ã€æ¡Œæ¤…å’Œè´­ä¹¦è¯»è€…'
            };

            const baseDescription = sceneMap[userData.theme] || `ä¸€ä¸ªå…³äº${userData.theme}çš„åœºæ™¯ï¼ŒåŒ…å«ç›¸å…³çš„ç‰©å“å’Œäººç‰©`;

            if (userData.environment) {
                return `${baseDescription}ï¼Œä½“ç°${userData.environment}çš„ç‰¹è‰²ã€‚`;
            }

            return baseDescription + 'ã€‚';
        }

        // è·å–äººç‰©æè¿°
        function getCharactersByTheme(theme) {
            const characterMap = {
                'è¶…å¸‚': 'è´­ç‰©å®¶åº­ã€æ”¶é“¶å‘˜ã€ç†è´§å‘˜',
                'å®¶é‡Œ': 'å®¶åº­æˆå‘˜ï¼ˆçˆ¶æ¯ã€å­©å­ï¼‰',
                'å­¦æ ¡': 'å­¦ç”Ÿã€è€å¸ˆ',
                'åŒ»é™¢': 'åŒ»ç”Ÿã€æŠ¤å£«ã€ç—…äºº',
                'å…¬å›­': 'æ¸¸å®¢ã€å­©å­ã€è€äºº',
                'æ¸¸ä¹åœº': 'å°æœ‹å‹ã€å®¶é•¿ã€å·¥ä½œäººå‘˜',
                'åŠ¨ç‰©å›­': 'æ¸¸å®¢ã€é¥²å…»å‘˜ã€å­©å­',
                'å…¬äº¤ç«™': 'ä¹˜å®¢ã€å¸æœºã€å­¦ç”Ÿ',
                'ç«è½¦ç«™': 'æ—…å®¢ã€ä¹˜åŠ¡å‘˜ã€å·¥ä½œäººå‘˜',
                'é£æœºåœº': 'æ—…å®¢ã€ç©ºä¹˜äººå‘˜ã€åœ°å‹¤äººå‘˜',
                'å›¾ä¹¦é¦†': 'è¯»è€…ã€å›¾ä¹¦ç®¡ç†å‘˜ã€å­¦ç”Ÿ',
                'åšç‰©é¦†': 'å‚è§‚è€…ã€è®²è§£å‘˜ã€ä¿å®‰',
                'ä¹¦åº—': 'è¯»è€…ã€åº—å‘˜ã€å­¦ç”Ÿ'
            };

            return characterMap[theme] || 'ç›¸å…³çš„äººç‰©å’Œè§’è‰²';
        }

        // ç”Ÿæˆæ ‡ç­¾æ ¼å¼ç¤ºä¾‹
        function generateTagFormatExample() {
            const formatMap = {
                'chinese': 'ä¸­æ–‡',
                'chinese,english': 'ä¸­æ–‡ (english)',
                'chinese,pinyin': 'ä¸­æ–‡ [pinyin]',
                'chinese,pinyin,english': 'ä¸­æ–‡ [pinyin] (english)',
                'chinese,pinyin,english,japanese': 'ä¸­æ–‡ [pinyin] (english) {japanese}'
            };

            const key = userData.languages.sort().join(',');
            return formatMap[key] || 'ä¸­æ–‡';
        }

        // ç”Ÿæˆè¯¦ç»†çš„æ ‡æ³¨ç¤ºä¾‹
        function generateDetailedTagExamples() {
            if (!vocabulary || vocabulary.length === 0) {
                return 'æš‚æ— è¯æ±‡ç¤ºä¾‹';
            }

            const exampleWords = vocabulary.slice(0, 3); // å–å‰3ä¸ªè¯æ±‡ä½œä¸ºç¤ºä¾‹
            let examples = '';

            exampleWords.forEach((word, index) => {
                let tagParts = [];

                if (userData.languages.includes('chinese')) {
                    tagParts.push(word.chinese);
                }
                if (userData.languages.includes('pinyin')) {
                    tagParts.push(`[${word.pinyin}]`);
                }
                if (userData.languages.includes('english')) {
                    tagParts.push(`(${word.english})`);
                }
                if (userData.languages.includes('japanese')) {
                    tagParts.push(`{${word.japanese}}`);
                }

                examples += `- ${word.chinese}: ${tagParts.join(' ')}\n`;
            });

            return examples;
        }

        // æ˜¾ç¤ºPrompt
        function displayPrompt() {
            const container = document.getElementById('promptResult');
            if (!container) {
                console.error('âŒ æœªæ‰¾åˆ°Promptç»“æœå®¹å™¨');
                return;
            }

            const html = `
                <div class="prompt-content">
                    <h3>ç”Ÿæˆçš„ç»˜å›¾Prompt</h3>
                    <pre>${finalPrompt}</pre>
                </div>
                <div class="prompt-actions">
                    <button class="btn btn-secondary" onclick="copyPrompt()">å¤åˆ¶Prompt</button>
                </div>
            `;

            container.innerHTML = html;
        }

        // è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤ - ç»ˆæä¿®å¤ç‰ˆ
        function goToStep(step) {
            console.log(`ğŸ¯ è·³è½¬åˆ°æ­¥éª¤ ${step}`);

            // éšè—æ‰€æœ‰æ­¥éª¤å†…å®¹
            document.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
            });

            // æ˜¾ç¤ºç›®æ ‡æ­¥éª¤
            const targetElement = document.getElementById(`step${step}`);
            if (targetElement) {
                targetElement.classList.add('active');
                console.log(`âœ… æˆåŠŸæ˜¾ç¤ºæ­¥éª¤ ${step}`);
                currentStep = step;

                // å¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo(0, 0);

                // éªŒè¯è·³è½¬æ˜¯å¦æˆåŠŸ
                setTimeout(() => {
                    const isVisible = targetElement.classList.contains('active') &&
                                   window.getComputedStyle(targetElement).display !== 'none';
                    if (isVisible) {
                        console.log(`âœ… æ­¥éª¤ ${step} æ˜¾ç¤ºéªŒè¯æˆåŠŸ`);
                    } else {
                        console.error(`âŒ æ­¥éª¤ ${step} æ˜¾ç¤ºéªŒè¯å¤±è´¥`);
                    }
                }, 100);

            } else {
                console.error(`âŒ æœªæ‰¾åˆ°æ­¥éª¤ ${step} çš„å…ƒç´ `);
                return;
            }

            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active');
                el.classList.remove('completed');
            });

            for (let i = 1; i <= step; i++) {
                const stepIndicator = document.querySelector(`.step[data-step="${i}"]`);
                if (stepIndicator) {
                    if (i < step) {
                        stepIndicator.classList.add('completed');
                    } else if (i === step) {
                        stepIndicator.classList.add('active');
                    }
                }
            }

            console.log(`âœ… æ­¥éª¤ ${step} è·³è½¬å¤„ç†å®Œæˆ`);
        }

        // ä¸Šä¸€æ­¥
        function previousStep() {
            console.log('â¬…ï¸ ä¸Šä¸€æ­¥');
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        // ä¸‹ä¸€æ­¥
        function nextStep() {
            console.log('â¡ï¸ ä¸‹ä¸€æ­¥ï¼Œå½“å‰æ­¥éª¤:', currentStep);

            switch (currentStep) {
                case 2:
                    generateTags();
                    goToStep(3);
                    break;
                case 3:
                    generatePrompt();
                    goToStep(4);
                    break;
                case 4:
                    goToStep(5);
                    break;
            }
        }

        // é‡æ–°å¼€å§‹
        function restart() {
            console.log('ğŸ”„ é‡æ–°å¼€å§‹');
            currentStep = 1;
            userData = {};
            vocabulary = [];
            tags = [];
            finalPrompt = '';

            // é‡ç½®è¡¨å•
            const form = document.getElementById('questionsForm');
            if (form) {
                form.reset();
            }

            goToStep(1);
        }

        // æ˜¾ç¤ºåŠ è½½æç¤º
        function showLoading(text) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');

            if (overlay && loadingText) {
                loadingText.textContent = text;
                overlay.classList.remove('hidden');
            }
        }

        // éšè—åŠ è½½æç¤º
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // å†å²è®°å½•ç®¡ç†
        function saveToHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('xiaozibao_history') || '[]');

                const record = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    theme: userData.theme,
                    title: userData.title,
                    languages: userData.languages,
                    difficulty: userData.difficulty,
                    environment: userData.environment,
                    vocabularyCount: vocabulary.length,
                    prompt: finalPrompt
                };

                history.unshift(record);

                // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                if (history.length > 20) {
                    history.splice(20);
                }

                localStorage.setItem('xiaozibao_history', JSON.stringify(history));
                console.log('ğŸ’¾ å†å²è®°å½•ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('âŒ ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            const history = JSON.parse(localStorage.getItem('xiaozibao_history') || '[]');
            const modal = document.getElementById('historyModal');
            const list = document.getElementById('historyList');

            if (!modal || !list) return;

            if (history.length === 0) {
                list.innerHTML = '<p class="no-history">æš‚æ— å†å²è®°å½•</p>';
            } else {
                let html = '';
                history.forEach(record => {
                    html += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-title">${record.title}</span>
                                <span class="history-item-time">${record.timestamp}</span>
                            </div>
                            <div class="history-item-details">
                                <div class="history-item-detail">ä¸»é¢˜ï¼š${record.theme}</div>
                                <div class="history-item-detail">è¯­è¨€ï¼š${record.languages.join(', ')}</div>
                                <div class="history-item-detail">è¯æ±‡æ•°ï¼š${record.vocabularyCount}</div>
                            </div>
                            <div class="history-item-actions">
                                <button class="btn btn-secondary" onclick="loadHistoryItem(${record.id})">åŠ è½½</button>
                                <button class="btn btn-info" onclick="copyHistoryPrompt(${record.id})">å¤åˆ¶Prompt</button>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            }

            modal.classList.remove('hidden');
        }

        // å…³é—­å†å²è®°å½•
        function closeHistory() {
            const modal = document.getElementById('historyModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearAllHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.removeItem('xiaozibao_history');
                alert('å†å²è®°å½•å·²æ¸…ç©º');
            }
        }

        // å¯¼å‡ºå†å²è®°å½•
        function exportHistory() {
            const history = JSON.parse(localStorage.getItem('xiaozibao_history') || '[]');

            if (history.length === 0) {
                alert('æ²¡æœ‰å†å²è®°å½•å¯ä»¥å¯¼å‡º');
                return;
            }

            const dataStr = JSON.stringify(history, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `xiaozibao_history_${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // å ä½å‡½æ•°
        function generateImage() {
            alert('å›¾åƒç”ŸæˆåŠŸèƒ½éœ€è¦é…ç½®API Key');
        }

        function downloadImage() {
            alert('è¯·å…ˆç”Ÿæˆå›¾åƒ');
        }

        function copyPrompt() {
            if (!finalPrompt) {
                alert('è¯·å…ˆç”ŸæˆPrompt');
                return;
            }

            navigator.clipboard.writeText(finalPrompt).then(() => {
                alert('Promptå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        function exportData() {
            if (!userData || !vocabulary || !tags) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            const exportData = {
                userData: userData,
                vocabulary: vocabulary,
                tags: tags,
                prompt: finalPrompt,
                exportTime: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `xiaozibao_${userData.title}_${Date.now()}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function loadHistoryItem(id) {
            alert('å†å²è®°å½•åŠ è½½åŠŸèƒ½å¼€å‘ä¸­...');
        }

        function copyHistoryPrompt(id) {
            alert('å†å²è®°å½•Promptå¤åˆ¶åŠŸèƒ½å¼€å‘ä¸­...');
        }

        console.log('ğŸ‰ ç»ˆæä¿®å¤ç‰ˆæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>